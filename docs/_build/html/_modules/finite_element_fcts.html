<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>finite_element_fcts &#8212; Gemini  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for finite_element_fcts</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">basix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">basix.ufl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ufl</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">basix.ufl</span><span class="w"> </span><span class="kn">import</span> <span class="n">element</span><span class="p">,</span> <span class="n">mixed_element</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ufl.finiteelement</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">basix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dolfinx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx</span><span class="w"> </span><span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">mesh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx.fem.petsc</span><span class="w"> </span><span class="kn">import</span> <span class="n">assemble_matrix</span><span class="p">,</span> <span class="n">assemble_vector</span><span class="p">,</span> <span class="n">LinearProblem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx.la</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx.fem</span><span class="w"> </span><span class="kn">import</span> <span class="n">Function</span><span class="p">,</span> <span class="n">FunctionSpace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx</span><span class="w"> </span><span class="kn">import</span> <span class="n">fem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx.fem</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dolfinx.mesh</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">petsc4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ufl</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">root_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;./&#39;</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">suppl_fcts</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">IO_fcts</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">builtins</span>


<span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span>

<div class="viewcode-block" id="print0">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.print0">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print0</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;stdout.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">builtins</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="alloc_fct_spaces">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.alloc_fct_spaces">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">alloc_fct_spaces</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">fe_degr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allocate and return the function spaces required for the &quot;a&quot; (single-pressure)</span>
<span class="sd">    and &quot;acv&quot; (multi-pressure) perfusion models, along with associated UFL functions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mesh : dolfinx.mesh.Mesh</span>
<span class="sd">        Mesh object defining the spatial domain.</span>
<span class="sd">    fe_degr : int</span>
<span class="sd">        Polynomial degree for pressure elements.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            - model_type : str</span>
<span class="sd">                Either &quot;a&quot; (single-pressure) or &quot;acv&quot; (default).</span>
<span class="sd">            - vel_order : int</span>
<span class="sd">                Degree for the velocity finite elements (default: fe_degr - 1).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (Vp, Vvel, v_1, v_2, v_3, p, p_1, p_2, p_3, K1_space, K2_space)</span>
<span class="sd">        Vp         : Pressure function space (scalar or mixed)</span>
<span class="sd">        Vvel       : Velocity vector function space</span>
<span class="sd">        v_1,2,3    : Components of test functions</span>
<span class="sd">        p, p_1,2,3 : Trial functions and their splits</span>
<span class="sd">        K1_space   : Tensor-valued permeability function space</span>
<span class="sd">        K2_space   : Scalar-valued permeability function space</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Supports DolfinX 0.9 with `basix.ufl.element` for consistent space creation.</span>
<span class="sd">    - Modular to easily extend for further model types.</span>
<span class="sd">    - MPI-aware printing via print0 is assumed available.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Initializing with fe_degr = </span><span class="si">{</span><span class="n">fe_degr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract optional arguments</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;acv&quot;</span><span class="p">)</span>
    <span class="n">vel_order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vel_order&quot;</span><span class="p">,</span> <span class="n">fe_degr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Mesh info</span>
    <span class="n">cell_type</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">cellname</span><span class="p">()</span>
    <span class="n">mesh_dim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
    <span class="n">num_cells</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">index_map</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">size_local</span>

    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Mesh type = </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">, dimension = </span><span class="si">{</span><span class="n">mesh_dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Number of cells = </span><span class="si">{</span><span class="n">num_cells</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Model type = &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39;, velocity order = </span><span class="si">{</span><span class="n">vel_order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Pressure space ---</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;acv&quot;</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Building mixed pressure space for &#39;acv&#39; model&quot;</span><span class="p">)</span>

        <span class="c1"># Three pressure components (P1, P2, P3)</span>
        <span class="n">scalar_p</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">fe_degr</span><span class="p">)</span>
        <span class="n">mixed_p</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">mixed_element</span><span class="p">([</span><span class="n">scalar_p</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">Vp</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mixed_p</span><span class="p">)</span>

        <span class="c1"># Split test/trial functions</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">Vp</span><span class="p">)</span>
        <span class="n">v_1</span><span class="p">,</span> <span class="n">v_2</span><span class="p">,</span> <span class="n">v_3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">Vp</span><span class="p">)</span>
        <span class="n">p_1</span><span class="p">,</span> <span class="n">p_2</span><span class="p">,</span> <span class="n">p_3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Building scalar pressure space for &#39;a&#39; model&quot;</span><span class="p">)</span>

        <span class="n">Vp</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">fe_degr</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">Vp</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">Vp</span><span class="p">)</span>

        <span class="c1"># No splitting needed for single-pressure model</span>
        <span class="n">v_1</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">v_2</span> <span class="o">=</span> <span class="n">v_3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">p_1</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">p_2</span> <span class="o">=</span> <span class="n">p_3</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown model type: &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Vp space dofs (global) = </span><span class="si">{</span><span class="n">Vp</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Permeability Tensor K1 ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Creating K1_space (tensor permeability)&quot;</span><span class="p">)</span>
    <span class="n">k_scalar</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">k_tensor</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">mixed_element</span><span class="p">([</span><span class="n">k_scalar</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mesh_dim</span> <span class="o">*</span> <span class="n">mesh_dim</span><span class="p">))</span>
    <span class="n">K1_space</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">k_tensor</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: K1_space dofs (global) = </span><span class="si">{</span><span class="n">K1_space</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Scalar Permeability K2 ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Creating K2_space (scalar permeability)&quot;</span><span class="p">)</span>
    <span class="n">K2_element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">K2_space</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">K2_element</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: K2_space dofs (global) = </span><span class="si">{</span><span class="n">K2_space</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Velocity space ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Creating Vvel (velocity space)&quot;</span><span class="p">)</span>
    <span class="n">vel_element</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span> <span class="k">if</span> <span class="n">vel_order</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">vel_order</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">,))</span>
    <span class="n">Vvel</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">vel_element</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;alloc_fct_spaces: Vvel space dofs (global) = </span><span class="si">{</span><span class="n">Vvel</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;alloc_fct_spaces: Allocation complete.&quot;</span><span class="p">)</span>
    <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Vp</span><span class="p">,</span> <span class="n">Vvel</span><span class="p">,</span> <span class="n">v_1</span><span class="p">,</span> <span class="n">v_2</span><span class="p">,</span> <span class="n">v_3</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p_1</span><span class="p">,</span> <span class="n">p_2</span><span class="p">,</span> <span class="n">p_3</span><span class="p">,</span> <span class="n">K1_space</span><span class="p">,</span> <span class="n">K2_space</span></div>


<div class="viewcode-block" id="set_up_fe_solver2">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.set_up_fe_solver2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">set_up_fe_solver2</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="p">],</span> 
                      <span class="n">subdomains</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span><span class="p">],</span> 
                      <span class="n">boundaries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">Mesh</span><span class="p">],</span> 
                      <span class="n">V</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">],</span> 
                      <span class="n">v_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Argument</span><span class="p">],</span> 
                      <span class="n">v_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Argument</span><span class="p">],</span> 
                      <span class="n">v_3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Argument</span><span class="p">],</span> 
                      <span class="n">p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">p_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">p_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">p_3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">K1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">K2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">K3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">beta12</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">beta23</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Coefficient</span><span class="p">],</span> 
                      <span class="n">pa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                      <span class="n">pv</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                      <span class="n">read_inlet_boundary</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
                      <span class="n">inlet_boundary_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                      <span class="n">inlet_BC_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                      <span class="o">**</span><span class="n">kwarg</span>
                      <span class="p">)</span><span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">fem</span><span class="o">.</span><span class="n">Form</span><span class="p">,</span> <span class="n">fem</span><span class="o">.</span><span class="n">Form</span><span class="p">,</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">,</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">,</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">fem</span><span class="o">.</span><span class="n">DirichletBC</span><span class="p">]]</span> <span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up and configure the finite element solver for blood flow modeling.</span>

<span class="sd">    This function prepares the finite element system for either:</span>
<span class="sd">    - ACV model (arterial-capillary-venous) with three compartments</span>
<span class="sd">    - A model (arterial-only) with single compartment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mesh : dolfinx.mesh.Mesh</span>
<span class="sd">        Computational mesh</span>
<span class="sd">    subdomains : dolfinx.mesh.MeshTags</span>
<span class="sd">        Subdomain markers for different tissue types</span>
<span class="sd">    boundaries : dolfinx.mesh.MeshTags</span>
<span class="sd">        Boundary markers for different boundary conditions</span>
<span class="sd">    V : dolfinx.fem.FunctionSpace</span>
<span class="sd">        Function space for the solution</span>
<span class="sd">    v_1, v_2, v_3 : ufl.Argument</span>
<span class="sd">        Test functions for each compartment</span>
<span class="sd">    p, p_1, p_2, p_3 : ufl.Coefficient</span>
<span class="sd">        Trial functions for pressure in each compartment</span>
<span class="sd">    K1, K2, K3 : ufl.Coefficient</span>
<span class="sd">        Conductivity tensors for each compartment</span>
<span class="sd">    beta12, beta23 : ufl.Coefficient</span>
<span class="sd">        Coupling coefficients between compartments</span>
<span class="sd">    pa : float</span>
<span class="sd">        Arterial pressure value</span>
<span class="sd">    pv : float</span>
<span class="sd">        Venous pressure value</span>
<span class="sd">    read_inlet_boundary : bool</span>
<span class="sd">        Flag to read boundary conditions from file</span>
<span class="sd">    inlet_boundary_file : str</span>
<span class="sd">        Path to boundary condition file</span>
<span class="sd">    inlet_BC_type : str</span>
<span class="sd">        Type of inlet boundary condition (&quot;DBC&quot;, &quot;NBC&quot;, or &quot;mixed&quot;)</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional parameters including:</span>
<span class="sd">        - model_type: &quot;acv&quot; or &quot;a&quot; (default: &quot;acv&quot;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple containing:</span>
<span class="sd">        - LHS: ufl.Form - Left-hand side of the variational problem</span>
<span class="sd">        - RHS: ufl.Form - Right-hand side of the variational problem</span>
<span class="sd">        - sigma1: fem.Constant - Source term for compartment 1</span>
<span class="sd">        - sigma2: fem.Constant - Source term for compartment 2  </span>
<span class="sd">        - sigma3: fem.Constant - Source term for compartment 3</span>
<span class="sd">        - BCs: List[fem.DirichletBC] - List of boundary conditions</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Handles both Dirichlet (DBC) and Neumann (NBC) boundary conditions</span>
<span class="sd">    - Supports reading boundary conditions from file or using defaults</span>
<span class="sd">    - Includes extensive debugging output</span>
<span class="sd">    - Parallel-safe printing with rank checking</span>
<span class="sd">    &quot;&quot;&quot;</span>

     <span class="c1"># Initialize MPI communication</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;acv&quot;</span><span class="p">)</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
    <span class="n">root</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Helper function for parallel-safe printing</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print0</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Initialize source terms (set to zero)</span>
    <span class="n">sigma1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">sigma3</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Used in reading BC_data, Will store boundary condition data</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;acv&quot;</span><span class="p">:</span>

        <span class="n">BCs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">integrals_N</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">read_inlet_boundary</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

            <span class="c1"># Load boundary condition data from CSV file</span>
            <span class="n">BC_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">inlet_boundary_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">BC_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;b1 = &#39;</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
            <span class="n">boundary_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">BC_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">BC_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                <span class="n">boundary_id</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># Identify facets corresponding to the given boundary label.</span>
                <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">boundary_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>
                
                <span class="c1"># For NBC, we may also prescribe a Dirichlet condition on compartment 3 (venous).</span>
                <span class="n">dofs_comp3</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                <span class="n">bc_venous</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pv</span><span class="p">),</span> <span class="n">dofs_comp3</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc_venous</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s2">&quot;DBC&quot;</span><span class="p">:</span>
                <span class="c1"># Dirichlet Boundary Condition loop</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">boundary_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>
                    <span class="c1"># Apply to compartment 1 if DBC</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">bc_func1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">dofs0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                    <span class="n">bc1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func1</span><span class="p">,</span> <span class="n">dofs0</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc1</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;NBC&#39;</span><span class="p">:</span>
                <span class="c1"># Neumann boundary conditions: Setup the measure using ufl.ds with subdomain_data provided.</span>
                
                <span class="c1"># First, adjust the flux values by the area associated with each boundary label.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="c1"># Define a form to compute the area of the boundary.</span>
                    <span class="n">area_form</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">area_form</span><span class="p">)</span>
                    <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">area</span>
                    
                <span class="c1"># Next, compute the Neumann boundary integrals.</span>
                <span class="c1"># Here, ufl.avg is used to properly handle the discretization for v_1.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">integrals_N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">v_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
                <span class="c1"># Neumann boundary conditions</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">boundary_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">bc_func1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">dofs0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                        <span class="n">bc1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func1</span><span class="p">,</span> <span class="n">dofs0</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Neumann (pressure gradient ~ flux) boundary condition</span>

                        <span class="n">area_form</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">area_form</span><span class="p">)</span>
                        <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">area</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Boundary condition in the BCs.csv file must be 0 (Dirichlet) or 1 (Neumann)&quot;</span><span class="p">)</span>
    
                    <span class="c1"># b1 includes the average surface-normal velocity for the perfusion regions</span>
                    <span class="c1"># computed from the volumentric flow rate [mm^3/s] and the surface area [mm^2]</span>
            
                <span class="k">if</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Neumann (pressure gradient ~ flux) boundary condition</span>
                    <span class="k">if</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">integrals_N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">v_1</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dS</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;inlet_BC_type must be Neumann or Dirichlet (&#39;NBC&#39; or &#39;DBC&#39;)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get boundary labels and number from your region_label_assembler</span>
            <span class="n">boundary_labels</span><span class="p">,</span> <span class="n">n_labels</span> <span class="o">=</span> <span class="n">suppl_fcts</span><span class="o">.</span><span class="n">region_label_assembler</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;DBC&#39;</span><span class="p">:</span> 
                <span class="c1"># Loop through the labels</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">label</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">dofs0</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                        <span class="n">dofs2</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                        <span class="n">bc_func1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>
                        <span class="n">bc_func2</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>

                        <span class="n">bc1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func1</span><span class="p">,</span> <span class="n">dofs0</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">bc2</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func2</span><span class="p">,</span> <span class="n">dofs2</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">BCs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">])</span>

            
                    
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;NBC&#39;</span><span class="p">:</span>
                <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inlet Type must be DBC for model &#39;a&#39; if &#39;read inlet Boundary: False&#39;&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
                <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inlet Type must be DBC for model &#39;a&#39; if &#39;read inlet Boundary: False&#39;&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
        <span class="c1"># Compute K1_tensor (as in model &#39;a&#39;)</span>
        <span class="c1"># Build the permeability tensors (assuming mesh_dim is defined and K1, K2, K3 have been read from file)</span>
        
        <span class="n">mesh_dim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>
        <span class="n">K1_components</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">K1</span><span class="p">)</span>
        <span class="n">K1_tensor</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">([[</span><span class="n">K1_components</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">mesh_dim</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)]</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)])</span>
                                
        <span class="n">K2_tensor</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)</span> <span class="o">*</span> <span class="n">K2</span>

        <span class="n">K3_components</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">K3</span><span class="p">)</span>
        <span class="n">K3_tensor</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">([[</span><span class="n">K3_components</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">mesh_dim</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)]</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)])</span>
        <span class="c1"># Define the variational form for the ACV model.</span>
        <span class="c1"># p_1, p_2, p_3 are the split components of the mixed pressure trial function,</span>
        <span class="c1"># and v_1, v_2, v_3 are the corresponding split test functions.</span>
        




        
        <span class="n">LHS</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span>
            <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">K1_tensor</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">p_1</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">beta12</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_1</span> <span class="o">-</span> <span class="n">p_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_1</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">K2_tensor</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">p_2</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_2</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">beta12</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_2</span> <span class="o">-</span> <span class="n">p_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_2</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">beta23</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_2</span> <span class="o">-</span> <span class="n">p_3</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_2</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">K3_tensor</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">p_3</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_3</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">beta23</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_3</span> <span class="o">-</span> <span class="n">p_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_3</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="p">)</span>

        <span class="n">RHS</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span>
            <span class="n">sigma1</span> <span class="o">*</span> <span class="n">v_1</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">sigma2</span> <span class="o">*</span> <span class="n">v_2</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">sigma3</span> <span class="o">*</span> <span class="n">v_3</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">integrals_N</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: RHS form:&quot;</span><span class="p">,</span> <span class="n">RHS</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: Assembling LHS...&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">LHS</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: Assembling RHS to test non-zero contributions...&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">RHS</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;b created&#39;</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>




    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
        <span class="c1"># Arterial-only model configuration</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pv&#39;</span><span class="p">,</span><span class="n">pv</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p_a</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">pa</span><span class="p">)</span>
        <span class="n">p_venous</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pv</span><span class="p">)</span>
        <span class="n">BCs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">integrals_N</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">read_inlet_boundary</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Similar boundary condition handling as ACV model but simplified</span>
            <span class="n">BC_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">inlet_boundary_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">BC_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">boundary_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">BC_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">BC_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>

            <span class="c1"># Dirichlet Boundary Conditions</span>
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s2">&quot;DBC&quot;</span><span class="p">:</span>
                 <span class="c1"># Dirichlet Boundary Condition loop</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">boundary_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>
                    <span class="c1"># Apply to compartment 1 if DBC</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">bc_func</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                    <span class="n">bc</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func</span><span class="p">,</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
                    <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
            <span class="c1"># Neumann Boundary Conditions</span>
            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s2">&quot;NBC&quot;</span><span class="p">:</span>
                <span class="c1"># Neumann BC handling</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boundary_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">boundary_id</span><span class="p">)</span>

                    <span class="n">area_form</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>
                    <span class="n">area</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">area_form</span><span class="p">)</span>
                    <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">area</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boundary_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Use avg(v_1) to properly handle DG space restrictions</span>
                        <span class="n">integrals_N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">v_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>

            <span class="c1"># Mixed Dirichlet and Neumann Boundary Conditions</span>
            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
                <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">boundary_id</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">boundary_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>

                    <span class="c1"># Defensive check</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Dirichlet BC</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">BC_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">bc_func1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                        <span class="n">bc1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func1</span><span class="p">,</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
                        <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc1</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Neumann BC (flux)</span>
                        <span class="n">area_form</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dS</span><span class="p">)</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">assemble_scalar</span><span class="p">(</span><span class="n">area_form</span><span class="p">)</span>
                        <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">area</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BC flag must be 0 or 1, but got </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2"> at row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># b1 includes the average surface-normal velocity for the perfusion regions</span>
                    <span class="c1"># computed from the volumentric flow rate [mm^3/s] and the surface area [mm^2]</span>
            
                <span class="k">if</span> <span class="n">BC_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Neumann (pressure gradient ~ flux) boundary condition</span>
                    <span class="k">if</span> <span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">integrals_N</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="n">v_1</span><span class="p">)</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">dS</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;inlet_BC_type must be Neumann or Dirichlet (&#39;NBC&#39; or &#39;DBC&#39;)&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Get boundary labels and number from your region_label_assembler</span>
            <span class="n">boundary_labels</span><span class="p">,</span> <span class="n">n_labels</span> <span class="o">=</span> <span class="n">suppl_fcts</span><span class="o">.</span><span class="n">region_label_assembler</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;DBC&#39;</span><span class="p">:</span> 
                <span class="c1"># Loop through the labels</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_labels</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">boundary_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">facet_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boundaries</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">facet_indices</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">label</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">boundary_facets</span><span class="p">)</span>
                       
                        <span class="n">bc_func</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">pa</span><span class="p">)</span>
                      
                        <span class="n">bc</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">bc_func</span><span class="p">,</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
                        
                        <span class="n">BCs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;NBC&#39;</span><span class="p">:</span>
                <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;Inlet Type must be DBC for model &#39;a&#39; if &#39;read inlet Boundary&#39; is False&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">inlet_BC_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
                <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;Inlet Type must be DBC for model &#39;a&#39; if &#39;read inlet Boundary&#39; is False&quot;</span><span class="p">)</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown inlet_BC_type &#39;</span><span class="si">{</span><span class="n">inlet_BC_type</span><span class="si">}</span><span class="s2">&#39; for model &#39;a&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Assemble arterial-only variational forms</span>
        <span class="n">beta_total</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">beta12</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">beta23</span><span class="p">)</span>
        <span class="n">mesh_dim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span>

         <span class="c1"># Handle tensor-valued K1</span>
        <span class="n">K1_components</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">K1</span><span class="p">)</span>
        <span class="n">K1_tensor</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">([[</span><span class="n">K1_components</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">mesh_dim</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)]</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mesh_dim</span><span class="p">)])</span>

        <span class="n">LHS</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span>
            <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">K1_tensor</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_1</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="n">beta12</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">v_1</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: LHS form:&quot;</span><span class="p">,</span> <span class="n">LHS</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;debug: integrals_N&quot;</span><span class="p">,</span> <span class="n">integrals_N</span><span class="p">)</span>

        <span class="n">RHS</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span>
            <span class="n">sigma1</span> <span class="o">*</span> <span class="n">v_1</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> <span class="o">+</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">integrals_N</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">beta_total</span> <span class="o">*</span> <span class="n">p_venous</span> <span class="o">*</span> <span class="n">v_1</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: RHS form:&quot;</span><span class="p">,</span> <span class="n">RHS</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: Assembling LHS...&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">LHS</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="c1"># Print values for local rows only</span>
        <span class="n">local_rows</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">getSize</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Get the size of the local matrix</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">RHS</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unknown model type: &quot;</span> <span class="o">+</span> <span class="n">model_type</span><span class="p">)</span>
    <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">LHS</span><span class="p">,</span> <span class="n">RHS</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigma3</span><span class="p">,</span> <span class="n">BCs</span></div>


<div class="viewcode-block" id="solve_lin_sys">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.solve_lin_sys">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">solve_lin_sys</span><span class="p">(</span><span class="n">V</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">],</span> 
                  <span class="n">LHS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Form</span><span class="p">],</span>
                  <span class="n">RHS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ufl</span><span class="o">.</span><span class="n">Form</span><span class="p">],</span> 
                  <span class="n">BCs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">DirichletBC</span><span class="p">],</span> 
                  <span class="n">lin_solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                  <span class="n">precond</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                  <span class="n">rtol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                  <span class="n">mon_conv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> 
                  <span class="n">init_sol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">],</span>
                  <span class="n">inlet_BC_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">]:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve a linear system of equations using PETSc solver with configurable options.</span>

<span class="sd">    1. Validates input arguments and function space compatibility.</span>
<span class="sd">    2. Assembles the linear system (matrix A and vector b).</span>
<span class="sd">    3. Applies boundary conditions and performs lifting operations.</span>
<span class="sd">    4. Configures PETSc solver based on boundary condition type.</span>
<span class="sd">    5. Solves the system and monitors convergence.</span>
<span class="sd">    6. Returns the solution as a Function in the specified function space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    V : dolfinx.fem.FunctionSpace</span>
<span class="sd">        The function space for the solution.</span>
<span class="sd">    LHS : ufl.Form</span>
<span class="sd">        The left-hand side bilinear form (matrix A).</span>
<span class="sd">    RHS : ufl.Form</span>
<span class="sd">        The right-hand side linear form (vector b).</span>
<span class="sd">    BCs : list[dolfinx.fem.DirichletBC]</span>
<span class="sd">        List of Dirichlet boundary conditions to apply.</span>
<span class="sd">    lin_solver : str</span>
<span class="sd">        PETSc solver type (e.g., &#39;gmres&#39;, &#39;cg&#39;, &#39;bcgs&#39;).</span>
<span class="sd">    precond : str</span>
<span class="sd">        PETSc preconditioner type (e.g., &#39;jacobi&#39;, &#39;hypre&#39;).</span>
<span class="sd">    rtol : float</span>
<span class="sd">        Relative tolerance for solver convergence.</span>
<span class="sd">    mon_conv : bool</span>
<span class="sd">        Flag to monitor convergence during solving.</span>
<span class="sd">    init_sol : Optional[dolfinx.fem.Function]</span>
<span class="sd">        Initial guess for the solution (optional).</span>
<span class="sd">    inlet_BC_type : str</span>
<span class="sd">        Type of inlet boundary condition (&#39;DBC&#39; for Dirichlet, &#39;NBC&#39; for Neumann).</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional optional arguments:</span>
<span class="sd">        - model_type: str - Type of model being solved</span>
<span class="sd">        - anchor_pressure: bool - Whether to anchor pressure at a point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dolfinx.fem.Function</span>
<span class="sd">        The solution to the linear system in the specified function space.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Includes extensive debugging output when called.</span>
<span class="sd">    - Automatically handles both Dirichlet and Neumann boundary conditions.</span>
<span class="sd">    - Uses PETSc&#39;s linear algebra backend for efficient solving.</span>
<span class="sd">    - Performs validation of function space compatibility before solving.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Extract model type from kwargs or set to None if not provided</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
     <span class="c1"># Set boundary condition type from input (defaults to &quot;DBC&quot; if not provided)</span>
    <span class="n">bc_type</span> <span class="o">=</span> <span class="n">inlet_BC_type</span>  <span class="c1"># defaults to &quot;DBC&quot; if not provided</span>
      <span class="c1"># Check if pressure anchoring is requested (default False)</span>
    <span class="n">anchor_pressure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;anchor_pressure&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>


    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===================== solve_lin_sys DEBUG START =====================&quot;</span><span class="p">)</span>
    <span class="c1"># --- DEBUG: Argument Types ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] V                  : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Function space type</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] LHS                : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">LHS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1"># Left-hand side form type</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] RHS                : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">RHS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Right-hand side form type</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] BCs                : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">BCs</span><span class="p">)</span><span class="si">}</span><span class="s2">, len = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">BCs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Boundary conditions</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] lin_solver         : </span><span class="si">{</span><span class="n">lin_solver</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">lin_solver</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="c1"># Solver type</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] precond            : </span><span class="si">{</span><span class="n">precond</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">precond</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="c1"># Preconditioner type</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] rtol               : </span><span class="si">{</span><span class="n">rtol</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rtol</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="c1"># Relative tolerance</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] mon_conv           : </span><span class="si">{</span><span class="n">mon_conv</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mon_conv</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="c1"># Monitor flag</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] init_sol           : </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">init_sol</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1"># Initial solution</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] kwargs             : </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="c1"># Additional arguments</span>

    <span class="c1"># --- DEBUG: Function Space Compatibility ---</span>
    <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Get function spaces from LHS and RHS forms</span>
        <span class="n">lhs_space</span> <span class="o">=</span> <span class="n">LHS</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rhs_space</span> <span class="o">=</span> <span class="n">RHS</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] LHS.function_space[0]: </span><span class="si">{</span><span class="n">lhs_space</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] RHS.function_space[0]: </span><span class="si">{</span><span class="n">rhs_space</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] V                    : </span><span class="si">{</span><span class="n">V</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Check if elements match</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lhs_space</span><span class="p">,</span> <span class="s2">&quot;ufl_element&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="s2">&quot;ufl_element&quot;</span><span class="p">):</span>
            <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] LHS.element == V.element? </span><span class="si">{</span><span class="n">lhs_space</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] RHS.element == V.element? </span><span class="si">{</span><span class="n">rhs_space</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">V</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Verify spaces match</span>
        <span class="k">assert</span> <span class="n">lhs_space</span> <span class="o">==</span> <span class="n">V</span><span class="p">,</span> <span class="s2">&quot;[DEBUG] LHS test space mismatch with V&quot;</span>
        <span class="k">assert</span> <span class="n">rhs_space</span> <span class="o">==</span> <span class="n">V</span><span class="p">,</span> <span class="s2">&quot;[DEBUG] RHS test space mismatch with V&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Function space validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- DEBUG: Boundary Conditions ---</span>
    <span class="k">for</span> <span class="n">bc_id</span><span class="p">,</span> <span class="n">bc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">BCs</span><span class="p">):</span>
        <span class="n">dofs</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">function_space</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">local_range</span>  <span class="c1"># This gets the local range of DoFs</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bc_func</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">function</span>
            <span class="c1"># Print first 5 BC function values if available</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="s1">&#39;get_boundary_dofs&#39;</span><span class="p">):</span>
            <span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">get_boundary_dofs</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># --- Assemble system ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Assembling matrix A...&quot;</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">LHS</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">BCs</span><span class="p">)</span>  <span class="c1"># Create PETSc matrix</span>
    <span class="n">A</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span><span class="c1"># Finalize matrix assembly</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Matrix A norm: </span><span class="si">{</span><span class="n">A</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Assembling vector b...&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_vector</span><span class="p">(</span><span class="n">RHS</span><span class="p">)</span><span class="c1"># Create PETSc vector</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] RHS norm before lifting: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
     <span class="c1"># Apply lifting operation for BCs</span>
    <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">apply_lifting</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">LHS</span><span class="p">],</span> <span class="p">[</span><span class="n">BCs</span><span class="p">])</span>
     <span class="c1"># Update ghost values</span>
    <span class="n">b</span><span class="o">.</span><span class="n">ghostUpdate</span><span class="p">(</span><span class="n">addv</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">InsertMode</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScatterMode</span><span class="o">.</span><span class="n">REVERSE</span><span class="p">)</span>
     <span class="c1"># Apply BCs to vector</span>
    <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">set_bc</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">BCs</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] RHS norm after lifting: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] First 10 RHS entries: </span><span class="si">{</span><span class="n">b</span><span class="o">.</span><span class="n">getArray</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

     <span class="c1"># --- Initialize solution vector ---</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span><span class="c1"># Create vector of same size as b</span>
    <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="c1"># Zero initial guess</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Initial solution norm: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- PETSc Solver Configuration ---</span>
    <span class="n">solver</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">KSP</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">()</span><span class="c1"># Create solver object</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">setOperators</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># Set system matrix</span>
    <span class="c1"># Use the lin_solver argument provided</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">lin_solver</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">precond</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">setFromOptions</span><span class="p">()</span>

    <span class="c1"># --- Select Solver Based on BC Type ---</span>
    <span class="k">if</span> <span class="n">bc_type</span> <span class="o">==</span> <span class="s2">&quot;NBC&quot;</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Using NBC-specific solver configuration...&quot;</span><span class="p">)</span>
        <span class="c1"># For NBC problems, you might choose an alternative solver type (e.g. gcr instead of bcgs)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;bcgs&quot;</span><span class="p">)</span>   <span class="c1"># Switch to a different Krylov solver type for NBC problems</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;hypre&quot;</span><span class="p">)</span>  <span class="c1"># Set the hypre preconditioner</span>
        <span class="c1"># Set tighter tolerances (or adjust as necessary)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-20</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">bc_type</span> <span class="o">==</span> <span class="s2">&quot;DBC&quot;</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Using DBC-specific solver configuration...&quot;</span><span class="p">)</span>
        <span class="c1"># For DBC problems, use the provided settings</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">lin_solver</span><span class="p">)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">precond</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Unrecognized bc_type provided; using default solver configuration.&quot;</span><span class="p">)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">lin_solver</span><span class="p">)</span>
        <span class="n">solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="n">precond</span><span class="p">)</span>

    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Solver type         : </span><span class="si">{</span><span class="n">solver</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Preconditioner type : </span><span class="si">{</span><span class="n">solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">getType</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Relative tolerance  : </span><span class="si">{</span><span class="n">rtol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- (Optional) Set a Monitor to print residuals during solve ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ksp_monitor</span><span class="p">(</span><span class="n">ksp</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">rnorm</span><span class="p">):</span>
        <span class="n">print0</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Iteration </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">: Residual norm = </span><span class="si">{</span><span class="n">rnorm</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">setMonitor</span><span class="p">(</span><span class="n">ksp_monitor</span><span class="p">)</span>

    <span class="c1"># --- Solve system ---</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Solving linear system...&quot;</span><span class="p">)</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="c1"># You can also enable PETSc&#39;s built-in monitor by uncommenting the next line:</span>
    <span class="c1"># PETSc.Options.setValue(&quot;ksp_monitor&quot;, &quot;&quot;)</span>

    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Solver converged reason : {solver.getConvergedReason()}&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Solver iterations       : {solver.getIterationNumber()}&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Final residual norm     : {solver.getResidualNorm():.3e}&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] First 10 entries of x   : {x.getArray()[:10]}&quot;</span><span class="p">)</span>
    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Final solution norm     : {x.norm():.3e}&quot;</span><span class="p">)</span>

<span class="c1"># --- Create Function from solution vector ---</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>  <span class="c1"># Initialize function in space V</span>

<span class="c1"># Assign solution to owned DoFs only</span>
    <span class="n">u</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[:</span><span class="n">x</span><span class="o">.</span><span class="n">getOwnershipRange</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">getOwnershipRange</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">array</span>

<span class="c1"># Update ghost values</span>
    <span class="n">u</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">scatter_forward</span><span class="p">()</span>



    <span class="n">print0</span><span class="p">(</span><span class="s2">&quot;===================== solve_lin_sys DEBUG END =======================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">u</span></div>


<div class="viewcode-block" id="func_space">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.func_space">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">func_space</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">eleD</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
    <span class="c1"># fenite element type and solution function space</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span>
    <span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span>                <span class="c1"># family (positional argument)</span>
    <span class="s2">&quot;tetrahedron&quot;</span><span class="p">,</span>           <span class="c1"># cell (positional argument)</span>
    <span class="mi">1</span><span class="p">,</span>                        <span class="c1"># order</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>                    <span class="c1"># degree (positional argument)</span>
     <span class="p">)</span>
    <span class="n">DG</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span>
    <span class="s2">&quot;DG&quot;</span><span class="p">,</span>                <span class="c1"># family (positional argument)</span>
    <span class="s2">&quot;tetrahedron&quot;</span><span class="p">,</span>           <span class="c1"># cell (positional argument)</span>
    <span class="mi">0</span><span class="p">,</span>                        <span class="c1"># order</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>                    <span class="c1"># degree (positional argument)</span>
    <span class="p">)</span>
    <span class="n">CG</span> <span class="o">=</span> <span class="n">basix</span><span class="o">.</span><span class="n">ufl</span><span class="o">.</span><span class="n">element</span><span class="p">(</span>
    <span class="s2">&quot;CG&quot;</span><span class="p">,</span>                <span class="c1"># family (positional argument)</span>
    <span class="s2">&quot;tetrahedron&quot;</span><span class="p">,</span>           <span class="c1"># cell (positional argument)</span>
    <span class="mi">1</span><span class="p">,</span>                        <span class="c1"># order</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>                    <span class="c1"># degree (positional argument)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Defined the finite element successfully&#39;</span><span class="p">)</span>
    
    <span class="n">Vc</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>    
    <span class="c1"># function spaces</span>
    <span class="n">DGSpace</span><span class="o">=</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">DG</span><span class="p">)</span>
    <span class="n">CGSpace</span><span class="o">=</span><span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span><span class="n">CG</span><span class="p">)</span>
    
    <span class="c1">#Velocity vector Space</span>
    <span class="k">if</span> <span class="n">eleD</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">uSpace</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uSpace</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">functionspace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="n">eleD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># beta</span>
    <span class="c1"># usage: xdmf_reader(variable, variable_name, folder)</span>
    <span class="n">beta_ac</span><span class="p">,</span> <span class="n">beta_cv</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">DGSpace</span><span class="p">),</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">DGSpace</span><span class="p">)</span>
    <span class="n">beta_ac</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">beta_ac</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">beta_ac</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    <span class="n">beta_cv</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">beta_cv</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">beta_cv</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>

    <span class="c1"># pressure</span>
    <span class="n">pa</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">CGSpace</span><span class="p">),</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">CGSpace</span><span class="p">),</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">CGSpace</span><span class="p">)</span>
    <span class="n">pa</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">pv</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pv</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    <span class="c1"># velocity</span>
    <span class="n">ua</span><span class="p">,</span> <span class="n">uc</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">uSpace</span><span class="p">),</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">uSpace</span><span class="p">)</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">ua</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    <span class="n">uc</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">xdmf_reader</span><span class="p">(</span><span class="n">uc</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">uc</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">para_path</span><span class="p">)</span>
    
    <span class="c1"># brain depth expression</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">DGSpace</span><span class="p">)</span>
    <span class="c1">#hdf5_reader(mesh, variable, variable_name, folder):</span>
    <span class="c1">#file_path = folder + variable_name + &#39;.h5&#39;</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">IO_fcts</span><span class="o">.</span><span class="n">hdf5_reader</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="s2">&quot;src/Gem_X/core/oxygen/&quot;</span><span class="p">)</span>

    <span class="n">depth_func_CG1</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">CGSpace</span><span class="p">)</span>  
    <span class="n">depth_func_CG1</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">Vc</span><span class="p">,</span> <span class="n">DGSpace</span><span class="p">,</span> <span class="n">CGSpace</span><span class="p">,</span> <span class="n">uSpace</span><span class="p">,</span> <span class="n">beta_ac</span><span class="p">,</span> <span class="n">beta_cv</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uc</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_func_CG1</span></div>


<span class="c1">#%% Calculation of artifitial diffusion</span>
<div class="viewcode-block" id="art_diff">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.art_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">art_diff</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">D_a</span><span class="p">,</span> <span class="n">DGSpace</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
    <span class="c1"># Calculate Peclet number</span>
    <span class="n">uaMag</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">ua</span><span class="p">))</span>  
    <span class="n">h</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">CellDiameter</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    
    <span class="c1"># Create functions for PehVal and Pehlim</span>
    <span class="n">PehVal</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">DGSpace</span><span class="p">)</span>
    <span class="n">Pehlim</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">DGSpace</span><span class="p">)</span>
    
    <span class="c1"># Interpolation for Pehlim based on depth condition</span>
    <span class="k">if</span> <span class="n">configs</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">Pehdepth</span><span class="p">:</span>
        <span class="n">Pehlim</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">depth</span><span class="p">)</span>

    <span class="c1"># Compute alpha values</span>
    <span class="n">num_dofs</span> <span class="o">=</span> <span class="n">DGSpace</span><span class="o">.</span><span class="n">dofmap</span><span class="o">.</span><span class="n">index_map</span><span class="o">.</span><span class="n">size_global</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dofs</span><span class="p">)</span>
    <span class="n">Peh_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dofs</span><span class="p">)</span>
    <span class="n">Peh_array</span> <span class="o">=</span> <span class="n">PehVal</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span>
    <span class="n">Pehlim_array</span> <span class="o">=</span> <span class="n">Pehlim</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span>

    <span class="c1"># Vectorized computation of alpha</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Peh_array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Pehlim_array</span><span class="p">))),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing alpha&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Peh_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">Peh_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">Peh_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">Pehlim_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="n">uaMag</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">ua</span><span class="p">))</span>

    <span class="c1"># Calculate dalta</span>
    <span class="n">dalta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">uaMag</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">D_a</span>
    <span class="k">return</span> <span class="n">dalta</span></div>

<span class="c1">#%% Compute DBC in arteriole compartment</span>

<span class="c1"># boundary labels: 0 interior face, 1 brain stem cut plane, 2 ventricular surface, 2+ (two digits) brain surface </span>
<div class="viewcode-block" id="BC">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.BC">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">BC</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">Vc</span><span class="p">,</span> <span class="n">configs</span><span class="p">):</span>
    
    <span class="n">BCa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># based on inlet boundary file</span>
    <span class="k">if</span> <span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">read_inlet_boundary</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">BC_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">pialBC_file</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">boundary_labels</span> <span class="o">=</span> <span class="n">BC_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">BC_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">BC_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">mesh</span> <span class="o">=</span> <span class="n">Vc</span><span class="o">.</span><span class="n">mesh</span>  
        <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">create_entities</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  
        <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">create_connectivity</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  
        

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">boundary_labels</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing boundary labels&quot;</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># Find suitable `label` facet</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">facets</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No facets found for label </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
            <span class="n">dofs</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">Vc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">facets</span><span class="p">)</span> 

            <span class="c1"># Create Dirichlet boundary conditions</span>
            <span class="n">BCa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">BCa</span><span class="p">,</span> <span class="n">dofs</span><span class="p">,</span> <span class="n">Vc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
            
    <span class="k">return</span> <span class="n">BCa</span></div>


<div class="viewcode-block" id="O2_Linear">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.O2_Linear">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">O2_Linear</span><span class="p">(</span><span class="n">beta12</span><span class="p">,</span> <span class="n">beta23</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">Vc</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uc</span><span class="p">,</span> <span class="n">phiA</span><span class="p">,</span> <span class="n">phiC</span><span class="p">,</span> <span class="n">phiT</span><span class="p">,</span> 
              <span class="n">D_a</span><span class="p">,</span> <span class="n">D_c</span><span class="p">,</span> <span class="n">D_t</span><span class="p">,</span> <span class="n">SaVa</span><span class="p">,</span> <span class="n">ScVc</span><span class="p">,</span> <span class="n">gammaA</span><span class="p">,</span> <span class="n">gammaC</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">BCa</span><span class="p">):</span>
   <span class="c1">#Test function and variables</span>
    <span class="n">v_a</span><span class="p">,</span> <span class="n">v_c</span><span class="p">,</span> <span class="n">v_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunctions</span><span class="p">(</span><span class="n">Vc</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">Vc</span><span class="p">)</span>
    <span class="n">C_a</span><span class="p">,</span> <span class="n">C_c</span><span class="p">,</span> <span class="n">C_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">beta12_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">beta12</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">beta23_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">beta23</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pa_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pc_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pv_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pv</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">ua_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">ua</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">uc_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">uc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">v_a_expr</span><span class="p">,</span> <span class="n">v_c_expr</span><span class="p">,</span> <span class="n">v_t_expr</span> <span class="o">=</span> <span class="n">v_a</span><span class="p">,</span> <span class="n">v_c</span><span class="p">,</span> <span class="n">v_t</span>

    <span class="c1">#Variables expression(weak)</span>
    <span class="n">LHS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ua_expr</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_a</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="mf">0.01813</span> <span class="o">*</span> <span class="mf">1.0e-3</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_a</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_a</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta12_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pa_expr</span> <span class="o">-</span> <span class="n">pc_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">SaVa</span> <span class="o">*</span> <span class="n">phiA</span> <span class="o">*</span> <span class="n">gammaA</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">uc_expr</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_c</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">D_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_c</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_c</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta12_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pa_expr</span> <span class="o">-</span> <span class="n">pc_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta23_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pc_expr</span> <span class="o">-</span> <span class="n">pv_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ScVc</span> <span class="o">*</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">gammaC</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiT</span> <span class="o">*</span> <span class="n">D_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_t</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">SaVa</span> <span class="o">*</span> <span class="n">phiA</span> <span class="o">*</span> <span class="n">gammaA</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">ScVc</span> <span class="o">*</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">gammaC</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiT</span> <span class="o">*</span> <span class="n">M</span> <span class="o">*</span> <span class="n">C_t</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
    <span class="p">)</span>

    <span class="c1">#Right Hand Side    </span>
    <span class="n">RHS</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_a_expr</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> \
        <span class="o">+</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_c_expr</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span> \
        <span class="o">+</span> <span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_t_expr</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
      
    <span class="n">problem</span> <span class="o">=</span> <span class="n">LinearProblem</span><span class="p">(</span><span class="n">LHS</span><span class="p">,</span> <span class="n">RHS</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">BCa</span><span class="p">,</span>
     <span class="n">petsc_options</span><span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bcgs&quot;</span><span class="p">}</span> <span class="p">)</span>
    
    <span class="n">C_sol</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

    <span class="c1">#Extract each component</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="n">C_sol</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Cc</span> <span class="o">=</span> <span class="n">C_sol</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Ct</span> <span class="o">=</span> <span class="n">C_sol</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">Cc</span><span class="p">,</span> <span class="n">Ct</span></div>


<div class="viewcode-block" id="O2_nonLinear">
<a class="viewcode-back" href="../files/finite_element_fcts.html#finite_element_fcts.O2_nonLinear">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">O2_nonLinear</span><span class="p">(</span><span class="n">beta12</span><span class="p">,</span> <span class="n">beta23</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ele</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">pv</span><span class="p">,</span> <span class="n">ua</span><span class="p">,</span> <span class="n">uc</span><span class="p">,</span> 
                             <span class="n">phiA</span><span class="p">,</span> <span class="n">phiC</span><span class="p">,</span> <span class="n">phiT</span><span class="p">,</span> <span class="n">D_a</span><span class="p">,</span> <span class="n">D_c</span><span class="p">,</span> <span class="n">D_t</span><span class="p">,</span> <span class="n">SaVa</span><span class="p">,</span> <span class="n">ScVc</span><span class="p">,</span> 
                             <span class="n">gammaA</span><span class="p">,</span> <span class="n">gammaC</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">C50</span><span class="p">,</span> <span class="n">BCa</span><span class="p">):</span>
    <span class="c1">#Create FiniteElements Space</span>
    <span class="n">Vc</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ele</span><span class="p">)</span>
    <span class="c1">#Test function and variables</span>
    <span class="n">v_a</span><span class="p">,</span> <span class="n">v_c</span><span class="p">,</span> <span class="n">v_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunctions</span><span class="p">(</span><span class="n">Vc</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Vc</span><span class="p">)</span>
    <span class="n">C_a</span><span class="p">,</span> <span class="n">C_c</span><span class="p">,</span> <span class="n">C_t</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">beta12_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">beta12</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">beta23_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">beta23</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pa_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pc_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">pv_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">pv</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">ua_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">ua</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="n">uc_expr</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">uc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="c1">#Variables expression(weak)</span>
    <span class="n">LHS</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ua_expr</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_a</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="mf">0.01813</span> <span class="o">*</span> <span class="mf">1.0e-3</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_a</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_a</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta12_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pa_expr</span> <span class="o">-</span> <span class="n">pc_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">SaVa</span> <span class="o">*</span> <span class="n">phiA</span> <span class="o">*</span> <span class="n">gammaA</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_a</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">uc_expr</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_c</span><span class="p">))</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">D_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_c</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_c</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta12_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pa_expr</span> <span class="o">-</span> <span class="n">pc_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">beta23_expr</span><span class="p">,</span> <span class="p">(</span><span class="n">pc_expr</span> <span class="o">-</span> <span class="n">pv_expr</span><span class="p">))</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">ScVc</span> <span class="o">*</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">gammaC</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_c</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiT</span> <span class="o">*</span> <span class="n">D_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">C_t</span><span class="p">),</span> <span class="n">ufl</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">v_t</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">SaVa</span> <span class="o">*</span> <span class="n">phiA</span> <span class="o">*</span> <span class="n">gammaA</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_a</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">-</span> <span class="n">ScVc</span> <span class="o">*</span> <span class="n">phiC</span> <span class="o">*</span> <span class="n">gammaC</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau</span> <span class="o">*</span> <span class="n">C_c</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
        <span class="o">+</span> <span class="n">phiT</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">C_t</span> <span class="o">/</span> <span class="p">(</span><span class="n">C50</span> <span class="o">-</span> <span class="n">C_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_t</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
    <span class="c1">#Calculate Jacobian determinant    </span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">LHS</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="c1">#Create Nonlinear Problem</span>
    <span class="n">problem</span><span class="o">=</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">NonlinearProblem</span><span class="p">(</span><span class="n">LHS</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">BCa</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span>
    <span class="c1">#Creat Newton Solver</span>
    <span class="n">solver</span><span class="o">=</span><span class="n">nls</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">NewtonSolver</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
    <span class="c1">#Set solver parameters</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">krylov_solver</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;gmres&quot;</span><span class="p">)</span> <span class="c1">#Linear Solver GMRES </span>
    <span class="n">solver</span><span class="o">.</span><span class="n">krylov_solver</span><span class="o">.</span><span class="n">getPC</span><span class="p">()</span><span class="o">.</span><span class="n">setType</span><span class="p">(</span><span class="s2">&quot;ilu&quot;</span><span class="p">)</span>  <span class="c1">#Preconditioner ILU</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">convergence_criterion</span> <span class="o">=</span> <span class="s2">&quot;incremental&quot;</span> 
    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Cc</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Ct</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">Cc</span><span class="p">,</span> <span class="n">Ct</span></div>

 

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Gemini</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files/background.html">Background Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/structure.html">Code Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/modernisation_concise.html">Modernisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/hpc.html">HPC Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/performance.html">Code Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/IO_fcts.html">IO_fcts module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/finite_element_fcts.html">finite_element_fcts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files/suppl_fcts.html">suppl_fcts</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Adam Brierley.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>