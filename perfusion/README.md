# Refactoring

This folder is currently in a refactoring phase. The following tutorial on how to run the basic flow solver may not be 
accurate to the actual state of the folder. 

Four different aspects are updated with the refactoring:
- modifying the structure of the code;
- adding and updating the documentation;
- updating the code of FEniCS legacy to FEniCSX;
- adding tests (unit, global, performance tests).

# basic_flow_solver

Running the 3D blood flow solver:

1; extract brain_meshes.tar.xz placed in the main repository

2; compute the permeability tensor with permeability_initialiser.py.
For parallel execution, use
mpirun -n #number_of_processors python3 permeability_initialiser.py
Using 4 cores execution takes typically less than 2 minutes.
Parameters are obtained from the config_permeability_initialiser.yaml file.
This script has to be executed only once.

3; compute the pressure and the velocity field using the basic_flow_solver.py.
The solver can be executed in parallel to compute the healthy perfusion field with
mpirun -n #number_of_processors python3 complex_geom_solver.py
Using 4 cores and first order finite elements, the execution is typically less than 2 minute.
Parameters are obtained from the config_basic_flow_solver.yaml file.

4; For occluded scenarios a boundary condition fiel has to be used to specify pressure/volumetric flow rate through cortical surface territories. BC_template.csv contains an example for right MCA occlusion. Similar files can be generated by running the BC_creator.py file (in serial):
python3 BC_creator.py

In the *.csv summarising the boundary conditions the cortical surface regions are numbered so that
21 - left ACA
22 - left MCA
23 - left PCA
24 - right ACA
25 - right MCA
26 - right PCA

To use the BC_template.csv, the config file has to be edited as shown in the config_basic_flow_solver_RMCAo.yaml file.
